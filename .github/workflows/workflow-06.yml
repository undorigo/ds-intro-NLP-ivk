name: Test in different OS

# === Events ===
on:
  workflow_dispatch: {}
  # push:
  #   branches: [ main ]
  #   paths: [ requirements.txt ]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  LOG_NOTEBOOK: "[NB]"
  LOG_SETUP: "[SETUP]"
  LOG_TEST: "[TEST]"

jobs:
  
  # =========================
  # Ubuntu
  # =========================
  Test_under_ubuntu:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-22.04, ubuntu-24.04 ]   # replaced 20.04 with 24.04
        python-version: ["3.11.3","3.12"] 
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix['python-version'] }}
          check-latest: true
          cache: pip

      - name: Install Rust (rustup) and HDF5 (apt)
        shell: bash
        run: |
          echo "$LOG_SETUP Install Rustup..."
          curl --proto '=https' --tlsv1.3 https://sh.rustup.rs -sSf | sh -s -- -y
          source "$HOME/.cargo/env"
          rustc --version || true
          rustup --version || true

          echo "$LOG_SETUP Install HDF5 dev libs..."
          sudo apt-get update -y
          sudo apt-get install -y libhdf5-dev hdf5-tools
          if command -v h5cc >/dev/null 2>&1; then h5cc -showconfig || h5cc -show; else echo "h5cc not found (ok)"; fi

      - name: Create import_libraries_test.py from Notebooks 
        run: |    
          echo "$LOG_NOTEBOOK Scanning notebooks for imports..."
          chmod +x .github/workflows/REGX_test_import_libraries.sh
          ./.github/workflows/REGX_test_import_libraries.sh
          echo "$LOG_NOTEBOOK Notebook import list generated."

      - name: Install dependencies 
        run: |
          echo "$LOG_SETUP Python + venv setup (Linux/macOS style)"
          python --version
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip --version
          pip list
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          echo "$LOG_SETUP Dependencies installed."

      - name: Test the import libraries
        run: |
          source .venv/bin/activate
          ./.github/workflows/REGX_test_import_libraries.sh
          echo "$LOG_TEST Running pytest on Ubuntu..."
          python -m pip install pytest
          pytest ./.github/workflows/testing/test_import_libraries.py -q
          echo "$LOG_TEST Ubuntu tests passed."


  # =========================
  # Windows
  # =========================
  Test_under_windows:
    defaults:
      run:
        shell: bash   # ensure Bash on Windows
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ windows-2022, windows-2025 ]
        python-version: ["3.11.3","3.12"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix['python-version'] }}
          check-latest: true
          cache: pip

      # Install Rust for Windows (needed if your Python deps build Rust extensions)
      - name: Install Rust (rustup) — Windows
        run: |
          echo "$LOG_SETUP Installing Rustup on Windows..."
          choco --version
          choco upgrade chocolatey -y
          choco install rustup.install -y || echo "rustup via choco may already be present"
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"
          rustup --version || true
          rustc --version || true

      # BEST/Trusted: vcpkg install HDF5 (x64) and export env vars for consumers (CMake/Python)
      - name: Setup vcpkg & install HDF5 (x64)
        run: |
          set -e

          # 1) Locate vcpkg preinstalled on the runner or install it
          if [ -d "/c/vcpkg" ]; then
            VCPKG_ROOT="C:/vcpkg"
          elif [ -d "/c/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/vcpkg" ]; then
            VCPKG_ROOT="C:/Program Files/Microsoft Visual Studio/2022/Enterprise/VC/vcpkg"
          elif [ -d "/c/Program Files/Microsoft Visual Studio/2022/Community/VC/vcpkg" ]; then
            VCPKG_ROOT="C:/Program Files/Microsoft Visual Studio/2022/Community/VC/vcpkg"
          else
            git clone https://github.com/microsoft/vcpkg.git /c/vcpkg
            cmd.exe /c "C:\\vcpkg\\bootstrap-vcpkg.bat"
            VCPKG_ROOT="C:/vcpkg"
          fi

          echo "VCPKG_ROOT=$VCPKG_ROOT" >> "$GITHUB_ENV"
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows" >> "$GITHUB_ENV"

          # 2) Install HDF5 for x64-windows
          "$VCPKG_ROOT/vcpkg.exe" install hdf5:x64-windows

          # 3) Make HDF5 discoverable
          echo "$VCPKG_ROOT/installed/x64-windows/bin" >> "$GITHUB_PATH"
          echo "HDF5_DIR=$VCPKG_ROOT/installed/x64-windows" >> "$GITHUB_ENV"
          echo "CMAKE_PREFIX_PATH=$VCPKG_ROOT/installed/x64-windows" >> "$GITHUB_ENV"
          echo "PKG_CONFIG_PATH=$VCPKG_ROOT/installed/x64-windows/lib/pkgconfig" >> "$GITHUB_ENV"

          # Optional visibility for MSVC-style builds that read INCLUDE/LIB
          echo "INCLUDE=$VCPKG_ROOT/installed/x64-windows/include" >> "$GITHUB_ENV"
          echo "LIB=$VCPKG_ROOT/installed/x64-windows/lib" >> "$GITHUB_ENV"

          # Quick check
          where h5dump || echo "h5dump not found in PATH yet (ok if DLLs are only runtime)"

      - name: Create import_libraries_test.py from Notebooks 
        run: |    
          echo "$LOG_NOTEBOOK Scanning notebooks for imports..."
          chmod +x .github/workflows/REGX_test_import_libraries.sh
          ./.github/workflows/REGX_test_import_libraries.sh
          echo "$LOG_NOTEBOOK Notebook import list generated."

      - name: Install dependencies 
        run: |
          echo "$LOG_SETUP Python + venv setup (Windows + Git Bash style)"
          echo "Note: Commands run under Bash (not PowerShell)."
          python --version
          python -m venv .venv
          source .venv/Scripts/activate
          python -m pip install --upgrade pip
          python -m pip --version
          pip list
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          echo "$LOG_SETUP Dependencies installed."

      - name: Test the import libraries
        run: |
          echo "Note: Commands run under Bash (not PowerShell)."
          source .venv/Scripts/activate
          ./.github/workflows/REGX_test_import_libraries.sh
          echo "$LOG_TEST Running pytest on Windows..."
          python -m pip install pytest
          pytest ./.github/workflows/testing/test_import_libraries.py -q
          echo "$LOG_TEST Windows tests passed."


  # =========================
  # macOS (Intel only)
  # =========================
  Test_under_macos_Intel:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-13 ]  # Intel (x86_64)
        python-version: ["3.11.3","3.12"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Print runner info
        run: |
          echo "$LOG_SETUP Runner: ${{ runner.os }} ${{ runner.arch }}"
          sw_vers
          uname -m
          python -V

      - name: Ensure Intel (x86_64)
        run: |
          [[ "$(uname -m)" == "x86_64" ]] || { echo "Expected x86_64 on macos-13"; exit 1; }

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix['python-version'] }}
          check-latest: true
          cache: pip

      - name: Install Rust (rustup) and HDF5 (brew) — Intel
        run: |
          echo "$LOG_SETUP Installing Rustup (Homebrew) on macOS Intel..."
          brew update
          brew install rustup
          rustup-init -y
          rustup --version || true
          rustc --version || true

          echo "$LOG_SETUP Installing HDF5 (brew)..."
          brew install hdf5
          if command -v h5cc >/dev/null 2>&1; then h5cc -showconfig || h5cc -show; else echo "h5cc not found (ok)"; fi

      - name: Create import_libraries_test.py from Notebooks 
        run: |    
          echo "$LOG_NOTEBOOK Scanning notebooks for imports..."
          chmod +x .github/workflows/REGX_test_import_libraries.sh
          ./.github/workflows/REGX_test_import_libraries.sh
          echo "$LOG_NOTEBOOK Notebook import list generated."

      - name: Install dependencies 
        run: |
          echo "$LOG_SETUP Python + venv setup (Linux/macOS style)"
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip --version
          pip list
          if [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          echo "$LOG_SETUP Dependencies installed."

      - name: Test the import libraries
        run: |
          source .venv/bin/activate
          ./.github/workflows/REGX_test_import_libraries.sh
          echo "$LOG_TEST Running pytest on macOS (Intel)..."
          python -m pip install pytest
          pytest ./.github/workflows/testing/test_import_libraries.py -q
          echo "$LOG_TEST macOS (Intel) tests passed."
          

  # =========================
  # macOS (Apple Silicon)
  # =========================
  Test_under_macos_Silicon:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ macos-14, macos-15 ]  # Apple Silicon (arm64)
        python-version: ["3.11.3","3.12"]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Print runner info
        run: |
          echo "$LOG_SETUP Runner: ${{ runner.os }} ${{ runner.arch }}"
          sw_vers
          uname -m
          python -V

      - name: Ensure Apple Silicon (arm64)
        run: |
          [[ "$(uname -m)" == "arm64" ]] || { echo "Expected arm64 on macOS Silicon (matrix.os=${{ matrix.os }})"; exit 1; }

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix['python-version'] }}
          check-latest: true
          cache: pip

      - name: Install Rust (rustup) and HDF5 (brew) — Silicon
        run: |
          echo "$LOG_SETUP Installing Rustup (Homebrew) on macOS Silicon..."
          brew update
          brew install rustup
          rustup-init -y
          rustup --version || true
          rustc --version || true

          echo "$LOG_SETUP Installing HDF5 (brew)..."
          brew install hdf5
          if command -v h5cc >/dev/null 2>&1; then h5cc -showconfig || h5cc -show; else echo "h5cc not found (ok)"; fi

      - name: Create import_libraries_test.py from Notebooks 
        run: |    
          echo "$LOG_NOTEBOOK Scanning notebooks for imports..."
          chmod +x .github/workflows/REGX_test_import_libraries.sh
          ./.github/workflows/REGX_test_import_libraries.sh 
          echo "$LOG_NOTEBOOK Notebook import list generated."

      - name: Install dependencies 
        run: |
          echo "$LOG_SETUP Python + venv setup (Linux/macOS style)"
          python -m venv .venv
          source .venv/bin/activate
          python -m pip install --upgrade pip
          python -m pip --version
          pip list
          if [ -f requirements_M1.txt ]; then python -m pip install -r requirements_M1.txt;
          elif [ -f requirements.txt ]; then python -m pip install -r requirements.txt; fi
          echo "$LOG_SETUP Dependencies installed."

      - name: Test the import libraries
        run: |
          source .venv/bin/activate
          ./.github/workflows/REGX_test_import_libraries.sh
          echo "$LOG_TEST Running pytest on macOS (Apple Silicon)..."
          python -m pip install pytest
          pytest ./.github/workflows/testing/test_import_libraries.py -q
          echo "$LOG_TEST macOS (Apple Silicon) tests passed."
